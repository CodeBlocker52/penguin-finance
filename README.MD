# ğŸ§ Penguin Finance

**Decentralized Liquid Staking Protocol on Solana**

Penguin Finance is a permissionless liquid staking protocol that allows anyone to create staking vaults, stake SOL, and earn rewards while maintaining liquidity through liquid staking tokens (LSTs).

## ğŸ“‹ Table of Contents

- [Introduction](#introduction)
- [Protocol Architecture](#protocol-architecture)
- [Key Features](#key-features)
- [Token Model](#token-model)
- [Project Structure](#project-structure)
- [User Flows](#user-flows)
- [Reward Mechanism](#reward-mechanism)
- [Security Features](#security-features)
- [Getting Started](#getting-started)

---

## ğŸ¯ Introduction

### Problem Statement

Traditional Solana staking has several limitations:
- **Locked liquidity**: Staked SOL is illiquid with unbonding periods
- **High barriers**: Managing validators requires technical expertise
- **Centralization**: Limited validator choice in pooled solutions
- **Capital inefficiency**: Cannot use staked SOL in DeFi

### Solution

Penguin Finance introduces a **vault-based liquid staking marketplace**:
- **Permissionless Vaults**: Anyone can create a staking vault
- **Liquid Staking Tokens**: Receive tradeable tokens representing staked SOL
- **Overcollateralized pSOL**: Unified liquid token backed by vault tokens
- **Market-Driven**: Operators compete on fees and performance
- **Isolated Risk**: Each vault operates independently

---

## ğŸ—ï¸ Protocol Architecture

### System Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Penguin Finance Protocol                    â”‚
â”‚         (Factory & Core Smart Contracts)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Vault A      â”‚      â”‚   Vault B      â”‚
â”‚ Solo Operator  â”‚      â”‚ Institution    â”‚
â”‚ Fee: 5%        â”‚      â”‚ Fee: 8%        â”‚
â”‚ Cap: 10K SOL   â”‚      â”‚ Cap: 100K SOL  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                      â”‚
        â”‚ Issues               â”‚ Issues
        â”‚ pVault-A             â”‚ pVault-B
        â”‚ tokens               â”‚ tokens
        â”‚                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User Deposits  â”‚      â”‚ User Deposits  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                      â”‚
        â”‚ Delegates            â”‚ Delegates
        â”‚ to Validators        â”‚ to Validators
        â”‚                      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   Solana Validators   â”‚
        â”‚   Earn Staking Rewards â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  pSOL (Global Token)  â”‚
        â”‚  Overcollateralized   â”‚
        â”‚  DeFi Composable      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Core Components

#### 1. **Factory Contract**
- Deploys new staking vaults
- Maintains vault registry
- Enforces protocol parameters
- Collects protocol fees

#### 2. **Vault Contracts**
- Independent staking pools
- Operator-managed
- Custom fee structures
- Isolated risk profiles
- Issue vault-specific LST tokens

#### 3. **pSOL Controller**
- Manages pSOL minting/burning
- Enforces overcollateralization
- Handles liquidations
- Aggregates vault rewards

#### 4. **Reward Oracle**
- Reports validator performance
- Calculates epoch rewards
- Updates vault exchange rates
- Consensus mechanism

---

## âœ¨ Key Features

### For Stakers

- âœ… **Any Amount**: Stake from 0.1 SOL (no minimum)
- âœ… **Instant Liquidity**: Receive tradeable LST tokens immediately
- âœ… **Vault Choice**: Select operators based on fees, performance, reputation
- âœ… **Diversification**: Spread stake across multiple vaults
- âœ… **DeFi Integration**: Use pSOL as collateral, LP, or in lending protocols
- âœ… **Compounding**: Automatic reward reinvestment

### For Operators

- âœ… **Permissionless**: Anyone can create a vault
- âœ… **Earn Fees**: Set custom fee structure (typically 5-10%)
- âœ… **Build Reputation**: Performance tracked on-chain
- âœ… **Flexible Capacity**: Set max vault size
- âœ… **Validator Control**: Choose which validators to delegate to
- âœ… **White-Label**: Custom branding and parameters

### Protocol Features

- âœ… **Risk Isolation**: Vault failures don't affect others
- âœ… **Overcollateralization**: pSOL backed by 110%+ of vault tokens
- âœ… **Decentralized**: No central operator whitelist
- âœ… **Composable**: Standard SPL token interface
- âœ… **Upgradeable**: Managed through governance

---

## ğŸª™ Token Model

### Two-Tier Token System

#### Tier 1: Vault Tokens (pVault-{ID})

**Characteristics:**
- Issued when users deposit SOL into specific vault
- Represents proportional ownership of vault's staked SOL
- Non-rebasing: value increases as rewards accrue
- Vault-specific: pVault-1 â‰  pVault-2
- Redeemable for SOL from originating vault

**Example:**
```
Vault #42 has:
- Total Assets: 1,000 SOL (staked + rewards)
- Total Supply: 950 pVault-42 tokens
- Exchange Rate: 1.0526 SOL per pVault-42

User deposits 10 SOL
Receives: 9.5 pVault-42 tokens
```

#### Tier 2: pSOL (Penguin SOL)

**Characteristics:**
- Unified liquid staking token
- Minted by locking vault tokens as collateral
- Overcollateralized (minimum 110% collateral ratio)
- Fungible across all vaults
- Optimized for DeFi integration
- Value accrues from underlying vault rewards

**Collateralization Example:**
```
User has: 10 pVault-42 (worth 10.526 SOL)
Mints: 9.5 pSOL
Collateral Ratio: 110.8%

Collateral continues earning staking rewards
User can use pSOL in DeFi applications
```

### Token Flow

```
SOL â†’ Vault Deposit â†’ pVault-X tokens
                           â†“
                    Lock as Collateral
                           â†“
                      Mint pSOL
                           â†“
                    Use in DeFi
                           â†“
                      Burn pSOL
                           â†“
                   Unlock pVault-X
                           â†“
                     Redeem for SOL
```

---

## ğŸ“ Project Structure

```
penguin-finance/
â”œâ”€â”€ programs/
â”‚   â””â”€â”€ penguin-finance/
â”‚       â”œâ”€â”€ src/
â”‚       â”‚   â”œâ”€â”€ lib.rs                 # Program entry point
â”‚       â”‚   â”œâ”€â”€ state/
â”‚       â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚       â”‚   â”‚   â”œâ”€â”€ factory.rs         # Protocol factory state
â”‚       â”‚   â”‚   â”œâ”€â”€ vault.rs           # Vault state
â”‚       â”‚   â”‚   â”œâ”€â”€ vault_token.rs     # Vault LST metadata
â”‚       â”‚   â”‚   â”œâ”€â”€ psol_controller.rs # pSOL controller state
â”‚       â”‚   â”‚   â””â”€â”€ user_position.rs   # User collateral positions
â”‚       â”‚   â”œâ”€â”€ instructions/
â”‚       â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚       â”‚   â”‚   â”œâ”€â”€ initialize_factory.rs
â”‚       â”‚   â”‚   â”œâ”€â”€ create_vault.rs
â”‚       â”‚   â”‚   â”œâ”€â”€ deposit_to_vault.rs
â”‚       â”‚   â”‚   â”œâ”€â”€ stake_from_vault.rs
â”‚       â”‚   â”‚   â”œâ”€â”€ update_vault_balance.rs
â”‚       â”‚   â”‚   â”œâ”€â”€ mint_psol.rs
â”‚       â”‚   â”‚   â”œâ”€â”€ burn_psol.rs
â”‚       â”‚   â”‚   â”œâ”€â”€ request_withdrawal.rs
â”‚       â”‚   â”‚   â””â”€â”€ claim_withdrawal.rs
â”‚       â”‚   â”œâ”€â”€ errors.rs              # Custom error codes
â”‚       â”‚   â”œâ”€â”€ events.rs              # Event emissions
â”‚       â”‚   â””â”€â”€ constants.rs           # Protocol constants
â”‚       â””â”€â”€ Cargo.toml
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ penguin-finance.ts             # Main test suite
â”‚   â”œâ”€â”€ vault-operations.ts            # Vault tests
â”‚   â”œâ”€â”€ psol-minting.ts                # pSOL tests
â”‚   â””â”€â”€ rewards.ts                     # Reward distribution tests
â”œâ”€â”€ migrations/
â”‚   â””â”€â”€ deploy.ts                      # Deployment script
â”œâ”€â”€ app/                               # Frontend (optional)
â”œâ”€â”€ Anchor.toml                        # Anchor configuration
â”œâ”€â”€ package.json
â””â”€â”€ README.md
```

### Key Directories

- **`state/`**: Account structures and data models
- **`instructions/`**: Business logic for each operation
- **`tests/`**: Comprehensive test coverage
- **`errors.rs`**: Custom error definitions
- **`events.rs`**: Event logs for indexing

---

## ğŸ‘¥ User Flows

### Flow 1: Operator Creates Vault

```
1. Operator calls create_vault()
   â””â”€ Parameters:
      â”œâ”€ fee_basis_points: u16 (e.g., 500 = 5%)
      â”œâ”€ max_capacity: u64 (in lamports)
      â””â”€ name: String

2. Protocol deploys new vault PDA
   â””â”€ Seeds: ["vault", factory, vault_id]

3. Vault token mint created
   â””â”€ Authority: vault PDA

4. Operator registered as vault authority

5. Vault listed in factory registry
```

### Flow 2: User Stakes SOL

```
1. User selects vault (based on fees, performance, trust)

2. User calls deposit_to_vault()
   â””â”€ Amount: 10 SOL

3. SOL transferred to vault account

4. Vault calculates shares:
   shares = amount Ã— total_shares / total_assets
   â””â”€ If first deposit: shares = amount

5. Vault mints pVault tokens to user
   â””â”€ User receives: 9.5 pVault-42 tokens

6. Vault's total_assets += 10 SOL
   â””â”€ total_shares += 9.5

7. Event emitted: DepositMade
```

### Flow 3: Vault Stakes to Validators

```
1. Operator calls stake_from_vault()
   â””â”€ validator_vote_account: Pubkey
   â””â”€ amount: u64

2. Vault creates stake account
   â””â”€ Authority: vault PDA
   â””â”€ Withdraw authority: vault PDA

3. Delegates stake to validator

4. Stake activates next epoch

5. Validators begin earning rewards

6. Event emitted: StakeDelegated
```

### Flow 4: Mint pSOL (Overcollateralized Token)

```
1. User has 10 pVault-42 tokens (worth 10.5 SOL)

2. User calls mint_psol()
   â””â”€ collateral_amount: 10 pVault-42
   â””â”€ psol_amount: 9.5 pSOL

3. Check collateralization:
   collateral_value = 10 Ã— exchange_rate = 10.5 SOL
   psol_value = 9.5 SOL
   ratio = 10.5 / 9.5 = 110.5% âœ“ (min: 110%)

4. Transfer pVault tokens to user position account

5. Mint 9.5 pSOL to user

6. Record position:
   â””â”€ collateral: 10 pVault-42
   â””â”€ debt: 9.5 pSOL

7. User can now use pSOL in DeFi

8. Event emitted: PsolMinted
```

### Flow 5: Reward Distribution

```
1. End of epoch, validators earn rewards

2. Oracle calls update_vault_balance()
   â””â”€ Reports new stake account balances

3. Vault calculates rewards:
   rewards = new_balance - old_balance

4. Apply operator fee:
   operator_fee = rewards Ã— fee_basis_points / 10000
   â””â”€ Mint fee shares to operator

5. Update exchange rate:
   total_assets += rewards
   â””â”€ User vault tokens now worth more

6. pSOL value increases proportionally
   â””â”€ Backed by more valuable collateral

7. Event emitted: RewardsDistributed
```

### Flow 6: Withdrawal Process

```
1. User calls burn_psol()
   â””â”€ Burns pSOL debt
   â””â”€ Unlocks pVault collateral

2. User calls request_withdrawal()
   â””â”€ Burns pVault tokens
   â””â”€ Creates withdrawal ticket NFT

3. Vault must deactivate stake:
   â””â”€ If buffered SOL available: instant
   â””â”€ Else: unstake from validator (waits 1-2 epochs)

4. When SOL available, user calls claim_withdrawal()
   â””â”€ Burns ticket NFT
   â””â”€ Receives SOL

5. Event emitted: WithdrawalCompleted
```

---

## ğŸ’° Reward Mechanism

### How Rewards Are Generated

#### Validator-Level Rewards

Solana validators earn from:
1. **Inflation Rewards**: ~5-7% APY from protocol inflation
2. **Transaction Fees**: Priority fees from users
3. **MEV**: Potential additional yield from transaction ordering

#### Vault-Level Collection

```
Epoch N ends:
â”œâ”€ Validator earned: 100 SOL in rewards
â”œâ”€ Vault's stake: 10,000 SOL (10% of validator)
â””â”€ Vault's share: 10 SOL
```

### Distribution Waterfall

```
Gross Rewards: 10 SOL
        â†“
Protocol Fee (1%): 0.1 SOL â†’ Treasury
        â†“
Remaining: 9.9 SOL
        â†“
Operator Fee (5%): 0.495 SOL â†’ Vault Operator
        â†“
Net to Stakers: 9.405 SOL
        â†“
Exchange Rate Increase
        â†“
All pVault token holders benefit proportionally
```

### Exchange Rate Calculation

```rust
// Before rewards
total_assets = 10,000 SOL
total_shares = 9,500 pVault tokens
exchange_rate = 10,000 / 9,500 = 1.0526 SOL per token

// After rewards (+9.405 SOL net)
total_assets = 10,009.405 SOL
total_shares = 9,500 pVault tokens (unchanged)
exchange_rate = 10,009.405 / 9,500 = 1.0536 SOL per token

// Growth: +0.0010 SOL per token
// APY: ~9.4% (annualized from epoch rewards)
```

### User Reward Accrual

**Example:**
```
User holds: 100 pVault-42 tokens

Beginning of epoch:
  Value: 100 Ã— 1.0526 = 105.26 SOL

End of epoch:
  Value: 100 Ã— 1.0536 = 105.36 SOL

Earned: 0.10 SOL (no action needed)
```

### pSOL Value Appreciation

Since pSOL is backed by vault tokens:
```
pSOL exchange rate = Î£(vault_collateral_value) / total_psol_supply

As vault tokens appreciate:
â””â”€ pSOL value increases proportionally
   â””â”€ Holders earn staking rewards while using pSOL in DeFi
```

---

## ğŸ”’ Security Features

### Vault Isolation

- Each vault is separate PDA
- Slashing in one vault doesn't affect others
- Users can avoid underperforming vaults
- Operators have skin in the game

### Overcollateralization

```
Health Factor = collateral_value / debt_value

Safe: â‰¥ 1.10 (110%)
Warning: < 1.10
Liquidatable: < 1.05
```

**Liquidation Process:**
1. Anyone can trigger liquidation of unhealthy positions
2. Liquidator repays debt (pSOL)
3. Receives collateral (vault tokens) at discount
4. Protects pSOL peg and solvency

### Authority Controls

```
Vault Authority Hierarchy:
â”œâ”€ Vault PDA (program-derived)
â”‚  â”œâ”€ Controls stake accounts
â”‚  â”œâ”€ Manages withdrawals
â”‚  â””â”€ Cannot be controlled by operator
â”œâ”€ Operator Account
â”‚  â”œâ”€ Can delegate stake
â”‚  â”œâ”€ Can update vault parameters
â”‚  â””â”€ Cannot withdraw user funds
â””â”€ Factory Authority (Governance)
   â”œâ”€ Can pause protocol
   â”œâ”€ Can update fees
   â””â”€ Cannot access user funds
```

### Withdrawal Credentials

- Stake accounts created with vault PDA as withdraw authority
- Operators cannot steal staked SOL
- Only vault PDA can initiate withdrawals
- Enforced at stake program level

### Time Locks

- Governance changes: 3-day timelock
- Fee increases: 7-day notice
- Emergency pause: Immediate (multisig)

---

## ğŸš€ Getting Started

### Prerequisites

```bash
# Install Rust
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh

# Install Solana CLI
sh -c "$(curl -sSfL https://release.solana.com/v1.18.0/install)"

# Install Anchor 0.31.1
cargo install --git https://github.com/coral-xyz/anchor --tag v0.31.1 anchor-cli
```

### Installation

```bash
# Clone repository
git clone https://github.com/your-org/penguin-finance
cd penguin-finance

# Install dependencies
npm install

# Build program
anchor build

# Run tests
anchor test
```

### Deployment

```bash
# Configure Solana to devnet
solana config set --url devnet

# Airdrop SOL for testing
solana airdrop 2

# Deploy program
anchor deploy

# Initialize factory
anchor run initialize
```

### Configuration

Edit `Anchor.toml`:
```toml
[programs.devnet]
penguin_finance = "YourProgramIDHere..."

[provider]
cluster = "devnet"
wallet = "~/.config/solana/id.json"
```

---

## ğŸ“Š Protocol Parameters

| Parameter | Value | Adjustable |
|-----------|-------|------------|
| Minimum Collateral Ratio | 110% | âœ… Governance |
| Liquidation Threshold | 105% | âœ… Governance |
| Protocol Fee | 1% | âœ… Governance |
| Maximum Vault Fee | 15% | âœ… Governance |
| Minimum Stake | 0.1 SOL | âœ… Governance |
| Withdrawal Delay | 1-2 epochs | âŒ Solana Protocol |

---

## ğŸ¯ Roadmap

### Phase 1: Core Protocol (Hackathon)
- âœ… Factory and vault contracts
- âœ… Vault token minting
- âœ… Basic staking delegation
- âœ… pSOL minting/burning
- âœ… Reward distribution
- âœ… Test suite

### Phase 2: Enhanced Features
- ğŸ”„ Oracle integration for automated rewards
- ğŸ”„ Liquidation engine
- ğŸ”„ Frontend dashboard
- ğŸ”„ Vault marketplace UI

### Phase 3: DeFi Integration
- ğŸ”„ Lending protocol integration
- ğŸ”„ DEX liquidity pools
- ğŸ”„ Cross-chain bridges
- ğŸ”„ Governance token launch

### Phase 4: Decentralization
- ğŸ”„ DAO governance
- ğŸ”„ Protocol-owned liquidity
- ğŸ”„ Community-driven development

---




**Built with ğŸ§ by the Penguin Finance Team**